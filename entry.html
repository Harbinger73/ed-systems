<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>Elite Dangerous New System</title>
	<link href="external/jquery-ui.css" rel="stylesheet">
	<link href="trilateration.css" rel="stylesheet">
	<script src="external/jquery-2.1.1.js"></script>
	<script src="external/stupidtable.min.js"></script>
	<script src="external/jquery-ui.js"></script>
	<script src="trilateration.js"></script>
<!--	<script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>-->
<script>
var systems = null;		// reference system data
var systemData = null;	// current system data
var jsonOutput = "";
var sqlOutput = "";
var systemsMap = {};
var names = [];

$(document).ready(function () {
	$.getJSON('systems.json', function(data) {
		systems = data;

		// generate system name map
		$.each(systems, function() {
			systemsMap[$.trim(this.name.toLowerCase())] = this;
		});

		// set up the autocomplete
		$.each(systems, function() {
			names.push(this.name);
		});
		names.sort();
		$("input.system-name").autocomplete({source: names});
	
		// setup sorting on the distance table
		$("#distances").stupidtable().bind('aftertablesort', updateSortArrow);

		// add the event handlers
		$('#cmdr-name').change(function() {
			var cmdr = $.trim(this.value);
			if (systemData !== null && cmdr.length > 0) {
				systemData.contributer = cmdr;
				$("#json-output").text(JSON.stringify(systemData, null, 2) + (jsonOutput.length > 0 ? ",\n" : "") + jsonOutput);
			}
		});

		$("#toggle-json").click(function() {
			$(this).text($("#json-output").is(":visible") ? "Show JSON" : "Hide JSON").attr("disabled", true);
			$("#json-output").toggle("fast", function() {
				$("#toggle-json").attr("disabled", false);
			});
		});

		$("#json-output").click(function() {
			if (window.getSelection) {
				var selection = window.getSelection();            
				var range = document.createRange();
				range.selectNodeContents(this);
				selection.removeAllRanges();
				selection.addRange(range);
			}
		});

		$("#toggle-sql").click(function() {
			$(this).text($("#sql-output").is(":visible") ? "Show SQL" : "Hide SQL").attr("disabled", true);
			$("#sql-output").toggle("fast", function() {
				$("#toggle-sql").attr("disabled", false);
			});
		});

		$("#sql-output").click(function() {
			if (window.getSelection) {
				var selection = window.getSelection();            
				var range = document.createRange();
				range.selectNodeContents(this);
				selection.removeAllRanges();
				selection.addRange(range);
			}
		});

		$("#done-button").click(function() {
			if (systemData !== null) {
				jsonOutput = JSON.stringify(systemData, null, 2) + (jsonOutput.length > 0 ? ",\n" : "") + jsonOutput;
				$("#json-output").text(jsonOutput);
				sqlOutput = getSQL(systemData) + sqlOutput;
				$("#sql-output").text(sqlOutput);
			}
			$("#cancel-button").click();
		});

		$("#cancel-button").click(function() {
			$("#distances input.distance").val("");
			$("#distances tr:has(input.system-name) td:nth-child(3)").text("").next().text("");
			$("#output").html("");
			$("#done-button").attr('disabled', true);
			$("#unknown-name").val("").focus();
			$("#json-output").text(jsonOutput);
			$("#sql-output").text(sqlOutput);
			$('#ref-warning').hide();
		});

		$('#unknown-name').change(function() {
			// check for duplicate name
			var dupe = false;
			if (this.value && this.value.length > 0) {
				var lc = $.trim(this.value.toLowerCase());
				$.each(systems, function() {
					if (this.name.toLowerCase() === lc) {
						dupe = true;
						return false;
					}
				});
			}
			$('#dupe-warning').toggle(dupe);
			
			if (systemData !== null) {
				systemData.name = this.value;
				$("#json-output").text(JSON.stringify(systemData, null, 2) + (jsonOutput.length > 0 ? ",\n" : "") + jsonOutput);
				$("#sql-output").text(getSQL(systemData) + sqlOutput);
				if (this.value.length > 0) $("#done-button").attr('disabled',false);
			}
		});
		
		$("#distances input").change(updateCoords);
		$('input.system-name').change(checkEmptyRow);

		addSystemRow();
	});
});

function checkEmptyRow() {
	var empty = false;
	$('input.system-name').each(function() {
		if (!this.value || this.value.length === 0) {
			empty = true
			return false;
		}
	});
	if (!empty) addSystemRow();
}

function addSystemRow() {
	 var tr = $('<tr><td><input class="system-name"></td><td><input class="distance"></td><td/><td/></tr>')
		.appendTo('#distances tbody');
	tr.find('input').change(updateCoords);
	tr.find('input.system-name')
		.change(checkEmptyRow)
		.autocomplete({source: names});
}

function updateCoords() {
	var dists = [];
	systemData = {name: $('#unknown-name').val()};
	systemData.calculated = true;
	var cmdr = $.trim($('#cmdr-name').val());
	if (cmdr.length > 0) systemData.contributer = cmdr;
	systemData.contributed = (new Date()).toJSON();
	systemData.distances = [];
	
	// hook the reference systems up to the data
	$("#distances input.system-name").each(function() {
		var n = $.trim(this.value.toLowerCase());
		if (n.length > 0) $(this).parentsUntil('table','tr').attr('system', n);
	});

	// get the distances
	$("#distances tr[system]").each(function() {
		var inp = $(this).find("input.distance");
		var dist = inp.val();
		var nameKey = this.getAttribute('system');
		var system = systemsMap[nameKey];
		var d = parseFloat(dist);

		if (isNaN(d)) {
			inp.val("");
		} else if (system !== undefined && !system.calculated) {
			if (d != (dist+0)) inp.val(d);	// parseFloat will parse anything starting with a valid float, so if that doesn't match the input then update the field
			dists.push({name: system.name, distance: d, x: system.x, y: system.y, z: system.z});
		}
	});

	// reset the calculated distances and errors.
	$("#distances tr:has(input.system-name) td:nth-child(3)").text("").next().text("");
	$("#output").html("");

	if (dists.length >= 4) {
		var bestCandidate = getBestCandidate(dists);
		if (bestCandidate !== null) {
			$('#ref-warning').hide();
			setVector(bestCandidate,gridLocation(bestCandidate));	// round to grid location

			$("#distances tr[system]").each(function() {
				var enteredDist = $(this).find("input.distance").val();
				if (enteredDist.length > 0) {
					var nameKey = this.getAttribute('system');
					if (!(nameKey in systemsMap)) {
						$(this).children("td:nth-child(3)").text("")
								.next().text("(unknown star)");
						return;
					}

					var sys = systemsMap[nameKey];
					var calcDist = dist(sys, bestCandidate);
					var err = Math.abs(enteredDist - calcDist).toFixed(3);
					if (sys.name === dists[bestCandidate.i1].name || sys.name === dists[bestCandidate.i2].name || sys.name === dists[bestCandidate.i3].name) {
						err += " (ref)";
					}
					if (sys.calculated) err += " (derived star)";
					$(this).children("td:nth-child(3)").text(calcDist.toFixed(3))
							.next().text(err);
				}
			});
	
			$("#output").html("Coordinates: "+vectorToString(bestCandidate)
					+"<br/>RMS error: "+(Math.sqrt(bestCandidate.totalSqErr/dists.length)).toFixed(3)
					+"<br/>Local Systems:");
			$("#output").append(getLocalSystems(bestCandidate)).append('<br/>');
			
			// update stored system data
			setVector(systemData, bestCandidate);
			for (var i = 0; i < dists.length; i++) {
				systemData.distances.push({
					system: dists[i].name,
					distance: dists[i].distance
				});
			}
			// add any unknown star data
			$("#distances tr[system]").each(function() {
				var sys = $(this).find('input.system-name').val();
				var dist = $(this).find('input.distance').val();
				if (sys.length > 0 && dist.length > 0 && !(this.getAttribute('system') in systemsMap)) {
					systemData.distances.push({system: sys, distance: dist});
				}
			});
			
			$("#json-output").text(JSON.stringify(systemData, null, 2) + (jsonOutput.length > 0 ? ",\n" : "") + jsonOutput);
			$("#sql-output").text(getSQL(systemData) + sqlOutput);

			if (systemData.name && systemData.name.length > 0) {
				$('#done-button').attr('disabled',false);
			} else {
				$('#unknown-name').focus();
			}
		} else {
			$('#ref-warning').show();
		}
	} else {
		$('#ref-warning').show();
	}
}

function getLocalSystems(coords) {
	var table = document.createElement('table');
	var row = document.createElement('tr');
	$('<th data-sort="string-ins">System</th>').appendTo(row);
	$('<th data-sort="float">X</th>').appendTo(row);
	$('<th data-sort="float">Y</th>').appendTo(row);
	$('<th data-sort="float">Z</th>').appendTo(row);
	$('<th data-sort="float">Distance</th>').appendTo(row);
	$('<thead/>').append(row).appendTo(table);
	var tbody = document.createElement('tbody');
	table.appendChild(tbody);

	var locals = [];
	for (i = 0; i < systems.length; i++) {
		locals.push({system:systems[i], distance:dist(systems[i],coords)});
	}
	locals.sort(function(a,b) {return a.distance-b.distance;});

	for (i = 0; i < 5 && i < locals.length; i++) {
		row = document.createElement('tr');
		$('<td>').text(locals[i].system.name).appendTo(row);
		$('<td>').text(locals[i].system.x).appendTo(row);
		$('<td>').text(locals[i].system.y).appendTo(row);
		$('<td>').text(locals[i].system.z).appendTo(row);
		$('<td>').text((locals[i].distance).toFixed(3)).appendTo(row);
		tbody.appendChild(row);
	}
	$(table).stupidtable().bind('aftertablesort', updateSortArrow);
	return table;
}

</script>
</head>
<body>
	<div class="ui-widget">
		<div style="float: right">
			<label for="cdmr-name">Commander Name (optional): </label>
			<input id="cmdr-name"/>
		</div>
		<label for="unknown-name">Name of new system: </label>
		<input id="unknown-name"/>

		<div id="dupe-warning" class="ui-state-error ui-corner-all" style="margin: 0.5em; display:none">
			<p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
			<strong>Warning:</strong> A system with that name has already been entered!</p>
		</div>

		<h3>Distances</h3>
		<table id="distances">
			<thead>
				<tr>
					<th data-sort="string-ins">System</th>
					<th>Distance</th>
					<th data-sort="float">Calculated</th>
					<th data-sort="float">Error</th>
				</tr>
			</thead>
			<tbody>
				<!-- Flousop, Tring, Rahu, Parcae, Hepa, Poqomathi, Hyperion, Aulin, Sol -->
				<tr><td><input class="system-name" value="Sol"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Wolf 497"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Huokang"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Demeter"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Clotti"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Fu Haiting"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="San Guaralaru"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Haras"></td><td><input class="distance"></td><td/><td/></tr>
				<tr><td><input class="system-name" value="Arabha"></td><td><input class="distance"></td><td/><td/></tr>
			</tbody>
		</table>
		<div id="ref-warning" class="ui-state-error ui-corner-all" style="margin: 0.5em; display:none">
			<p><span class="ui-icon ui-icon-alert" style="float: left; margin-right: .3em;"></span>
			<strong>Warning:</strong> Need more distances to reference systems!</p>
		</div>
		<h3>Calculated</h3>
		<div id="output"></div>
		<button id="done-button" disabled="true">Done</button><button id="cancel-button">Cancel</button>
		<h3>Structured Output</h3>
		<button id="toggle-json">Show JSON</button><button id="toggle-sql">Show SQL</button>
		<pre id="sql-output" style="display:none"></pre>
		<pre id="json-output" style="display:none"></pre>
	</div>
</body>
</html>
